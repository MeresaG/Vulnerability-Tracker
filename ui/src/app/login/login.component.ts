import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { Router } from '@angular/router';
import { AuthService } from '../auth.service';
import { TokenStorageService } from '../token-storage.service';

export class User {
  _id! : string;
  userName! : String;
  email!: string;
  role!: string;
  accessToken!:string;
}

@Component({
  selector: 'app-login',
  templateUrl: './login.component.html',
  styleUrls: ['./login.component.css']
})
export class LoginComponent implements OnInit {

  loginForm!:FormGroup;

  isLoggedIn = false;
  errorMessage = "";
  submitted = false;

  user : User = new User();

  constructor(private route: Router , private authService: AuthService, private tokenStorage: TokenStorageService, private fb:FormBuilder) { 
    this.loginForm = this.fb.group({
      email : ['', [Validators.required, Validators.email]],
      password : ['', [
        Validators.required, 
        Validators.pattern('^(?=.*[A-Za-z])(?=.*[$@$!%*#?&]).{8,}$')
    ]]
    })
  }

  ngOnInit(): void {

    this.submitted = false;

    if(this.tokenStorage.getToken()) {
      this.isLoggedIn = true;
      this.user = this.tokenStorage.getUser();
      // this.route.navigate(['dashboard']);
    } 
    

  }

  public login():void {
    this.submitted = true;
    if(this.loginForm.valid) {

      this.authService.login(this.loginForm.value).subscribe( {
        
        next : data => {         
          this.tokenStorage.saveToken(data.accessToken);
          this.tokenStorage.saveUser(data);
          this.isLoggedIn = true;
          this.user = this.tokenStorage.getUser();
          this.route.navigate(['dashboard'])
  
        },
        error : err => {
          this.errorMessage = "Wrong Email or Password!";
        }
      }
      );

    }
    
  }
  reloadPage(): void {
    window.location.reload();
  }

}
